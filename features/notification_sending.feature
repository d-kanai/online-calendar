Feature: 通知の送信
  リマインドや招待が適切なチャネルで参加者へ配信されるようにしたい

  Rule: 通知チャネル設定の管理
    参加者は自分の通知設定を制御できる
    無効な通知チャネルには通知が送信されない

    Scenario: メールでリマインドを送信する
      Given 参加者 "hanako@example.com" がメールチャネルを有効にしている
      And リマインドイベントがキューに入っている
      When 通知サービスがジョブを処理する
      Then "hanako@example.com" にメールが送信される
      And 送信ステータスが "SUCCESS" になる

    Scenario: 全通知チャネルが無効な参加者へのリマインダー除外
      Given 参加者のメール通知とプッシュ通知が両方無効になっている
      When リマインダー送信時刻になる
      Then その参加者にはリマインダーが送信されない
      And リマインダー送信対象者リストから除外される

    Scenario: 有効な通知チャネルがある参加者へのリマインダー送信
      Given 参加者のメール通知が有効になっている
      And 参加者のプッシュ通知が無効になっている
      When リマインダー送信時刻になる
      Then その参加者にメールでリマインダーが送信される
      And プッシュ通知は送信されない

  Rule: 新規参加者のデフォルト通知設定
    新しく追加された参加者には適切なデフォルト通知設定が適用される
    参加者は後から設定を変更できる

    Scenario: 新規参加者のデフォルト通知設定
      Given オーナーが新しい参加者を追加する
      When 参加者が正常に追加される
      Then その参加者のメール通知が有効になっている
      And その参加者のプッシュ通知が無効になっている

    Scenario: 参加者が自分の通知設定を変更
      Given 参加者が会議に招待されている
      When その参加者が自分のメール通知設定を無効に変更する
      Then その参加者の通知設定が更新される
      And 次回のリマインダー送信時に反映される

  Rule: リマインダー送信の時間精度
    リマインダー送信時刻の判定には許容誤差がある
    システムの負荷を考慮した現実的な実装を行う

    Scenario: リマインダー送信時刻の1分間許容誤差
      Given 会議のリマインダー送信予定時刻が10:00である
      When 現在時刻が10:00:30（30秒遅れ）になる
      Then リマインダーが正常に送信される
      And 送信遅延として記録される
